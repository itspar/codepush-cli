name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          registry-url: 'https://registry.npmjs.org'

      # Install system dependencies
      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libbz2-dev

      - name: Install npm dependencies
        run: npm ci

      - name: Build
        run: npm run build

      # Check if version changed
      - name: Check version change
        id: version_check
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"
          
          # Get previous version from the last commit
          git show HEAD~1:package.json > /tmp/old-package.json 2>/dev/null || echo '{"version":"0.0.0"}' > /tmp/old-package.json
          PREVIOUS_VERSION=$(node -p "require('/tmp/old-package.json').version")
          echo "Previous version: $PREVIOUS_VERSION"
          
          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
            echo "Version changed from $PREVIOUS_VERSION to $CURRENT_VERSION"
            echo "VERSION_CHANGED=true" >> $GITHUB_ENV
            echo "PACKAGE_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
            echo "PACKAGE_NAME=$(node -p "require('./package.json').name")" >> $GITHUB_ENV
          else
            echo "Version unchanged - skipping release"
            echo "VERSION_CHANGED=false" >> $GITHUB_ENV
          fi

      # Check if version exists on NPM
      - name: Check NPM version
        if: env.VERSION_CHANGED == 'true'
        run: |
          if npm view ${{ env.PACKAGE_NAME }}@${{ env.PACKAGE_VERSION }} version 2>/dev/null; then
            echo "Warning: Version ${{ env.PACKAGE_VERSION }} already exists on npm"
            echo "SKIP_PUBLISH=true" >> $GITHUB_ENV
          else
            echo "Version ${{ env.PACKAGE_VERSION }} is ready for publishing"
            echo "SKIP_PUBLISH=false" >> $GITHUB_ENV
          fi

      # Create GitHub Release
      - name: Create GitHub Release
        if: env.VERSION_CHANGED == 'true' && env.SKIP_PUBLISH == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.PACKAGE_VERSION }}
          name: Release v${{ env.PACKAGE_VERSION }}
          body: |
            ## Release v${{ env.PACKAGE_VERSION }}
            
            üöÄ New version published to NPM: [${{ env.PACKAGE_NAME }}@${{ env.PACKAGE_VERSION }}](https://www.npmjs.com/package/${{ env.PACKAGE_NAME }})
            
            ### Installation
            ```bash
            npm install -g ${{ env.PACKAGE_NAME }}@${{ env.PACKAGE_VERSION }}
            ```
          draft: false
          prerelease: false
          token: ${{ secrets.TOKEN }}

      # Publish to npm
      - name: Publish to NPM
        if: env.VERSION_CHANGED == 'true' && env.SKIP_PUBLISH == 'false'
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Skip notification
        if: env.VERSION_CHANGED == 'false' || env.SKIP_PUBLISH == 'true'
        run: |
          if [ "${{ env.VERSION_CHANGED }}" == "false" ]; then
            echo "‚è≠Ô∏è Skipped - version unchanged in package.json"
          else
            echo "‚è≠Ô∏è Skipped - version already exists on NPM"
          fi
